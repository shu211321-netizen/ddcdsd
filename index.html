<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ë¬¸ì œí’€ì´ íƒ€ì´ë¨¸</title>
<style>
body{margin:0;font-family:system-ui;background:#fff}
#app{min-height:100vh;display:flex;flex-direction:column;justify-content:flex-end;padding:14px;box-sizing:border-box}
.card{border:1px solid #e6e6e6;border-radius:18px;padding:14px;margin-top:12px}
.time{font-size:18vw;font-weight:900;text-align:center;letter-spacing:-.04em;line-height:1}
.sub{text-align:center;color:#666;margin-top:6px}
.row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
input,button{flex:1;padding:14px;font-size:18px;border-radius:14px;border:1px solid #ccc;box-sizing:border-box}
button{background:#111;color:#fff;font-weight:900;border:none}
.sec{background:#eee;color:#111}
.muted{color:#666;font-size:13px;margin-top:8px}

.panel{border:1px solid #eee;border-radius:18px;overflow:hidden;margin-top:12px}
.panel-h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fafafa}
.panel-h b{font-size:14px}
.panel-h button{flex:0;padding:8px 10px;border-radius:12px;font-size:14px}
.panel-b{padding:10px 12px;display:none}
.show .panel-b{display:block}

.rankTabs{display:flex;gap:8px;margin:8px 0}
.tab{flex:1;padding:10px;border-radius:12px;border:1px solid #ddd;background:#fff;color:#111;font-weight:900;font-size:14px}
.tab.on{background:#111;color:#fff;border-color:#111}
.rank{display:flex;flex-direction:column;gap:8px;max-height:28vh;overflow:auto}
.rankItem{display:flex;justify-content:space-between;gap:10px;border:1px solid #eee;border-radius:14px;padding:10px 12px}
.badge{font-weight:900;min-width:44px;text-align:center}

dialog{border:none;border-radius:18px;padding:16px;width:90vw;max-width:420px}
dialog::backdrop{background:rgba(0,0,0,.4)}
.err{color:#b00020;font-size:13px;margin-top:8px;display:none}

.pills{display:flex;gap:10px;margin-top:10px}
.pill{flex:1;padding:12px;border-radius:14px;border:1px solid #ccc;background:#fff;color:#111;font-weight:900}
.pill.on{background:#111;color:#fff;border-color:#111}
</style>
</head>

<body>
<div id="app">
  <div class="card">
    <div class="time" id="time">25:00</div>
    <div class="sub" id="state">ì¤€ë¹„ë¨</div>
  </div>

  <div class="card">
    <div class="row">
      <input id="min" type="number" value="25" min="0" placeholder="ë¶„">
      <input id="sec" type="number" value="0" min="0" max="59" placeholder="ì´ˆ">
    </div>
    <div class="row">
      <button id="start">ì‹œì‘</button>
      <button id="pause" class="sec" disabled>ì¼ì‹œì •ì§€</button>
      <button id="resume" class="sec" disabled>ì¬ì‹œì‘</button>
      <button id="finish" class="sec" disabled>ì¢…ë£Œ</button>
      <button id="reset" class="sec">ë¦¬ì…‹</button>
    </div>
    <div class="row">
      <button id="manual" class="sec">+ ê¸°ë¡ ì¶”ê°€(ìˆ˜ë™)</button>
    </div>
    <div class="muted">â€» ë‹¤ë¥¸ ì•±ì„ ì—´ì–´ë„ â€œì‹œê°„ì€ ê³„ì† íë¥¸ ê±¸ë¡œâ€ ê³„ì‚°ë¨(ì‹œê° ê¸°ì¤€).</div>
  </div>

  <div class="panel" id="rankPanel">
    <div class="panel-h">
      <b>ğŸ† ë­í‚¹(ì •ë‹µë¥  ê¸°ì¤€)</b>
      <div style="display:flex;gap:8px">
        <button id="rankToggle" class="sec">í¼ì¹˜ê¸°</button>
        <button id="clear" class="sec">ì‚­ì œ</button>
      </div>
    </div>
    <div class="panel-b">
      <div class="rankTabs">
        <button id="tabAll" class="tab on" type="button">ì „ì²´</button>
        <button id="tabMath" class="tab" type="button">ìˆ˜í•™</button>
        <button id="tabSci" class="tab" type="button">ê³¼í•™</button>
      </div>
      <div id="rank" class="rank"></div>
      <div class="muted">ì •ë ¬: ì •ë‹µë¥ â†“ â†’ í‘¼ ê°œìˆ˜â†“ â†’ ìµœì‹ </div>
    </div>
  </div>
</div>

<dialog id="dlg">
  <b id="dlgTitle">ê¸°ë¡ ì…ë ¥</b>

  <div class="muted" id="spentInfo" style="margin-top:6px"></div>

  <div class="muted" style="margin-top:10px">ê³¼ëª©(2ê°œ)</div>
  <div class="pills">
    <button id="math" class="pill on" type="button">ìˆ˜í•™</button>
    <button id="sci" class="pill" type="button">ê³¼í•™</button>
  </div>

  <div class="muted" style="margin-top:10px">ì •ë‹µ í˜•ì‹: (ë§ì€ê°œìˆ˜)/(í‘¼ê°œìˆ˜) ì˜ˆ) 18/25</div>
  <input id="score" placeholder="ì˜ˆ: 18/25" style="width:100%;margin-top:8px">

  <div class="muted" style="margin-top:10px">ê³µë¶€ì‹œê°„(ë¶„) â€” ìˆ˜ë™ ì¶”ê°€ì¼ ë•Œë§Œ ì§ì ‘ ì…ë ¥</div>
  <input id="manualMin" type="number" min="0" placeholder="ì˜ˆ: 25" style="width:100%;margin-top:8px">

  <div class="err" id="err">ì…ë ¥ì„ í™•ì¸í•´ì¤˜.</div>

  <div class="row" style="margin-top:10px">
    <button id="skip" class="sec" type="button">ì·¨ì†Œ</button>
    <button id="save" type="button">ì €ì¥</button>
  </div>
</dialog>

<script>
(() => {
  // ====== ì €ì¥ í‚¤ ======
  const DATA_KEY = "rankData_manual_v2";
  const TIMER_KEY = "timerState_v1"; // ë°±ê·¸ë¼ìš´ë“œìš© ìƒíƒœ ì €ì¥

  const $ = (id) => document.getElementById(id);

  const timeEl = $("time"), stateEl = $("state");
  const minEl = $("min"), secEl = $("sec");
  const startBtn = $("start"), pauseBtn = $("pause"), resumeBtn = $("resume"), resetBtn = $("reset"), finishBtn = $("finish");
  const manualBtn = $("manual");

  const rankPanel = $("rankPanel"), rankToggle = $("rankToggle"), clearBtn = $("clear");
  const tabAll = $("tabAll"), tabMath = $("tabMath"), tabSci = $("tabSci");
  const rankEl = $("rank");

  const dlg = $("dlg"), dlgTitle = $("dlgTitle");
  const scoreEl = $("score"), errEl = $("err"), spentInfo = $("spentInfo"), manualMinEl = $("manualMin");
  const mathBtn = $("math"), sciBtn = $("sci");
  const saveBtn = $("save"), skipBtn = $("skip");

  // ====== ë°ì´í„° ======
  let subject = "ìˆ˜í•™";
  let filter = "ì „ì²´";
  let data = JSON.parse(localStorage.getItem(DATA_KEY) || "[]");

  // ====== íƒ€ì´ë¨¸ ìƒíƒœ(ì‹œê° ê¸°ë°˜) ======
  // totalSec: ì„¤ì •ëœ ì „ì²´ ì‹œê°„
  // startTs: ë‹¬ë¦¬ê¸° ì‹œì‘í•œ ì‹œê°(ms) (runningì¼ ë•Œë§Œ ì˜ë¯¸)
  // elapsedBeforeSec: ì¼ì‹œì •ì§€ë¡œ ëˆ„ì ëœ ê²½ê³¼ì‹œê°„(ì´ˆ)
  // running: í˜„ì¬ ì§„í–‰ì¤‘ ì—¬ë¶€
  let totalSec = 25*60;
  let startTs = null;
  let elapsedBeforeSec = 0;
  let running = false;

  let uiTick = null; // í™”ë©´ ì—…ë°ì´íŠ¸ìš©(ë°±ê·¸ë¼ìš´ë“œì—ì„œ ê³„ì† ì•ˆ ëŒì•„ë„ ë¨)

  // ====== ë‹¤ì´ì–¼ë¡œê·¸ ëª¨ë“œ ======
  let dlgMode = "auto"; // "auto" | "manual"

  // ====== ìœ í‹¸ ======
  const pad = (n) => String(n).padStart(2, "0");
  const fmt = (s) => `${pad(Math.floor(s / 60))}:${pad(s % 60)}`;
  const medal = (i) => i===1?"ğŸ¥‡":i===2?"ğŸ¥ˆ":i===3?"ğŸ¥‰":`#${i}`;

  function nowMs(){ return Date.now(); }

  function getElapsedSec(){
    if(!running) return elapsedBeforeSec;
    return elapsedBeforeSec + (nowMs() - startTs)/1000;
  }

  function getRemainingSec(){
    const rem = totalSec - getElapsedSec();
    return Math.max(0, Math.round(rem));
  }

  function drawTime(){
    timeEl.textContent = fmt(getRemainingSec());
  }

  function setButtons(){
    startBtn.disabled = running;
    pauseBtn.disabled = !running;
    // ì¬ì‹œì‘: ì¼ì‹œì •ì§€ ìƒíƒœ(=running false)ì´ê³ , í•œë²ˆì´ë¼ë„ ì‹œì‘í•œ ìƒíƒœ
    resumeBtn.disabled = running || (startTs===null && elapsedBeforeSec===0) || getRemainingSec()<=0;
    finishBtn.disabled = (startTs===null && elapsedBeforeSec===0); // ì‹œì‘í•œ ì  ì—†ìœ¼ë©´ ì¢…ë£Œ ë¶ˆê°€
    minEl.disabled = running;
    secEl.disabled = running;
  }

  function saveTimerState(){
    const st = { totalSec, startTs, elapsedBeforeSec, running };
    localStorage.setItem(TIMER_KEY, JSON.stringify(st));
  }

  function loadTimerState(){
    const raw = localStorage.getItem(TIMER_KEY);
    if(!raw) return false;
    try{
      const st = JSON.parse(raw);
      if(typeof st.totalSec!=="number") return false;
      totalSec = st.totalSec;
      startTs = st.startTs;
      elapsedBeforeSec = st.elapsedBeforeSec || 0;
      running = !!st.running;

      // runningì¸ë° ë„ˆë¬´ ì˜¤ë˜ ì§€ë‚˜ì„œ 0ì´ë©´ ìë™ ì¢…ë£Œ ì²˜ë¦¬
      if(getRemainingSec()<=0){
        running = false;
        // elapsedë¥¼ totalë¡œ ë§ì¶°ì„œ 0ìœ¼ë¡œ ê³ ì •
        elapsedBeforeSec = totalSec;
        startTs = null;
        stateEl.textContent = "ì™„ë£Œ";
        saveTimerState();
      }
      return true;
    }catch{ return false; }
  }

  function syncFromInputs(){
    const mm = Math.max(0, Math.min(300, parseInt(minEl.value || 0, 10) || 0));
    const ss = Math.max(0, Math.min(59,  parseInt(secEl.value || 0, 10) || 0));
    minEl.value = mm; secEl.value = ss;
    totalSec = Math.max(1, mm*60 + ss);
    // ë¦¬ì…‹ ì„±ê²©(ì„¤ì •ë§Œ ë°”ê¾¸ëŠ” ê²½ìš°)ì¼ ë•Œë§Œ ì¨ì•¼ í•¨
  }

  function startUiTick(){
    if(uiTick) clearInterval(uiTick);
    uiTick = setInterval(() => {
      drawTime();
      // ì‹œê°„ì´ ë‹¤ ë˜ë©´ ìë™ìœ¼ë¡œ ìƒíƒœë§Œ ë°”ê¾¸ê³  ì…ë ¥ì°½ ë„ìš°ì§„ ì•ŠìŒ(ë°±ê·¸ë¼ìš´ë“œ ë³µê·€ ëŒ€ë¹„)
      if(running && getRemainingSec()<=0){
        running=false;
        elapsedBeforeSec = totalSec;
        startTs=null;
        stateEl.textContent="ì™„ë£Œ";
        setButtons();
        saveTimerState();
        // ë°”ë¡œ ë‹¤ì´ì–¼ë¡œê·¸ ë„ìš°ê³  ì‹¶ìœ¼ë©´ ì—¬ê¸°ì„œ openDlg("auto","ì‹œê°„ ì¢…ë£Œ") í˜¸ì¶œí•˜ë©´ ë¨
      }
    }, 300);
  }

  function stopUiTick(){
    if(uiTick){ clearInterval(uiTick); uiTick=null; }
  }

  // ====== ê³¼ëª© ì„ íƒ ======
  function pickSub(s){
    subject = s;
    mathBtn.classList.toggle("on", s==="ìˆ˜í•™");
    sciBtn.classList.toggle("on", s==="ê³¼í•™");
  }
  mathBtn.onclick = () => pickSub("ìˆ˜í•™");
  sciBtn.onclick  = () => pickSub("ê³¼í•™");

  // ====== ê¸°ë¡ ì…ë ¥ì°½ ======
  function openDlg(mode, reason){
    dlgMode = mode;
    errEl.style.display="none";
    scoreEl.value="";
    manualMinEl.value="";

    if(mode==="manual"){
      dlgTitle.textContent="ê¸°ë¡ ì¶”ê°€(ìˆ˜ë™)";
      spentInfo.textContent="ìˆ˜ë™ ê¸°ë¡: ê³µë¶€ì‹œê°„(ë¶„)ì„ ì§ì ‘ ì ì–´ì¤˜.";
      manualMinEl.placeholder="ì˜ˆ: 25";
    }else{
      dlgTitle.textContent="ê¸°ë¡ ì…ë ¥";
      const spentSec = Math.max(0, Math.round(getElapsedSec()));
      spentInfo.textContent = `ê¸°ë¡ ì‹œê°„: ${fmt(spentSec)} (ì‚¬ìœ : ${reason})`;
      manualMinEl.placeholder="ìë™ì´ë©´ ë¹„ì›Œë„ ë¨";
    }
    dlg.showModal();
  }

  // ====== íƒ€ì´ë¨¸ ë™ì‘ ======
  function startTimer(){
    // ì²˜ìŒ ì‹œì‘ì´ë©´ ì…ë ¥ê°’ìœ¼ë¡œ total ì„¤ì • + ì´ˆê¸°í™”
    if(startTs===null && elapsedBeforeSec===0 && !running){
      syncFromInputs();
      elapsedBeforeSec = 0;
      startTs = nowMs();
      running = true;
    } else {
      // ì´ë¯¸ ì¼ì‹œì •ì§€ ìƒíƒœì˜€ë‹¤ë©´ resumeë¡œ ì²˜ë¦¬
      startTs = nowMs();
      running = true;
    }
    stateEl.textContent="ì§„í–‰ ì¤‘";
    drawTime();
    setButtons();
    saveTimerState();
    startUiTick();
  }

  function pauseTimer(){
    if(!running) return;
    // ëˆ„ì  ê²½ê³¼ì— ë”í•˜ê³  ë©ˆì¶¤
    elapsedBeforeSec = getElapsedSec();
    running = false;
    startTs = null;
    stateEl.textContent="ì¼ì‹œì •ì§€";
    setButtons();
    saveTimerState();
  }

  function finishTimer(){
    // ì–¸ì œë“  ì¢…ë£Œ ê°€ëŠ¥(ì‹œì‘í•œ ì  ìˆì–´ì•¼)
    if(startTs===null && elapsedBeforeSec===0) return;
    // runningì´ë©´ ê²½ê³¼ ê³„ì‚° ê³ ì •
    elapsedBeforeSec = getElapsedSec();
    running = false;
    startTs = null;
    stateEl.textContent="ì¢…ë£Œë¨";
    setButtons();
    saveTimerState();
    openDlg("auto","ìˆ˜ë™ ì¢…ë£Œ");
  }

  function resetTimer(){
    running=false;
    startTs=null;
    elapsedBeforeSec=0;
    stateEl.textContent="ì¤€ë¹„ë¨";
    syncFromInputs();
    // ì„¤ì •ê°’ì„ totalSecë¡œ ë°˜ì˜í•œ í›„ ì´ˆê¸°í™”
    // (syncFromInputsê°€ totalSec ë°”ê¿¨ìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ)
    saveTimerState();
    drawTime();
    setButtons();
  }

  // ë²„íŠ¼ ì—°ê²°
  startBtn.onclick  = startTimer;
  pauseBtn.onclick  = pauseTimer;
  resumeBtn.onclick = startTimer;
  finishBtn.onclick = finishTimer;
  resetBtn.onclick  = resetTimer;

  manualBtn.onclick = () => openDlg("manual","");

  // ====== ë­í‚¹ ======
  function setFilter(f){
    filter = f;
    tabAll.classList.toggle("on", f==="ì „ì²´");
    tabMath.classList.toggle("on", f==="ìˆ˜í•™");
    tabSci.classList.toggle("on", f==="ê³¼í•™");
    renderRank();
  }
  tabAll.onclick=()=>setFilter("ì „ì²´");
  tabMath.onclick=()=>setFilter("ìˆ˜í•™");
  tabSci.onclick=()=>setFilter("ê³¼í•™");

  function renderRank(){
    rankEl.innerHTML="";
    let arr = data.slice();
    if(filter!=="ì „ì²´") arr = arr.filter(e=>e.subject===filter);

    arr.sort((a,b)=>(b.acc-a.acc)||(b.solved-a.solved)||(b.ts-a.ts));
    const top = arr.slice(0,10);

    if(!top.length){
      rankEl.innerHTML = `<div class="muted">ê¸°ë¡ ì—†ìŒ. ì €ì¥í•´ë´!</div>`;
      return;
    }

    top.forEach((e,i)=>{
      const div=document.createElement("div");
      div.className="rankItem";
      const d=new Date(e.ts);
      const stamp=`${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      div.innerHTML = `
        <div class="badge">${medal(i+1)}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:900">${e.subject} Â· ${e.correct}/${e.solved} Â· ${e.acc}%</div>
          <div class="muted">${stamp} Â· ê³µë¶€ ${fmt(e.spentSec||0)}</div>
        </div>
        <div style="font-weight:900">${e.acc}%</div>
      `;
      rankEl.appendChild(div);
    });
  }

  rankToggle.onclick=()=>{
    const on=!rankPanel.classList.contains("show");
    rankPanel.classList.toggle("show",on);
    rankToggle.textContent=on?"ì ‘ê¸°":"í¼ì¹˜ê¸°";
  };

  clearBtn.onclick=()=>{
    if(!confirm("ê¸°ë¡ ì „ë¶€ ì‚­ì œí• ê¹Œ?")) return;
    data=[];
    localStorage.setItem(DATA_KEY,"[]");
    renderRank();
  };

  // ====== ì €ì¥ ======
  saveBtn.onclick=()=>{
    const v=(scoreEl.value||"").trim();
    const m=v.match(/^(\d+)\s*\/\s*(\d+)$/);
    if(!m){ errEl.textContent="í˜•ì‹ì´ ì˜ëª»ëì–´. ì˜ˆ: 18/25"; errEl.style.display="block"; return; }
    const correct=parseInt(m[1],10), solved=parseInt(m[2],10);
    if(!(solved>0 && correct>=0 && correct<=solved)){
      errEl.textContent="ìˆ«ìê°€ ì´ìƒí•´. (0 â‰¤ ë§ì€ê°œìˆ˜ â‰¤ í‘¼ê°œìˆ˜)";
      errEl.style.display="block"; return;
    }

    let spentSec;
    if(dlgMode==="manual"){
      const mm = parseInt(manualMinEl.value||"",10);
      if(!(mm>=0)){ errEl.textContent="ìˆ˜ë™ ê¸°ë¡ì€ ê³µë¶€ì‹œê°„(ë¶„)ì„ ìˆ«ìë¡œ ì ì–´ì¤˜."; errEl.style.display="block"; return; }
      spentSec = mm*60;
    } else {
      // ìë™ ê¸°ë¡: ì‹¤ì œ ê²½ê³¼ì‹œê°„
      spentSec = Math.max(0, Math.round(getElapsedSec()));
      // ì‚¬ìš©ìê°€ ìˆ˜ë™ ì‹œê°„ ë„£ìœ¼ë©´ ë®ì–´ì“°ê¸° í—ˆìš©
      const mm = parseInt(manualMinEl.value||"",10);
      if(mm>=0) spentSec = mm*60;
    }

    const acc=Math.round(correct/solved*100);
    data.push({ts:Date.now(),subject,correct,solved,acc,spentSec});
    localStorage.setItem(DATA_KEY,JSON.stringify(data));

    dlg.close();
    renderRank();

    if(dlgMode!=="manual"){
      resetTimer();
    }
  };

  skipBtn.onclick=()=>{ dlg.close(); if(dlgMode!=="manual") resetTimer(); };

  // ====== í˜ì´ì§€ ìˆ¨ê¹€/ë³µê·€ ì²˜ë¦¬ ======
  // ì•±ì„ ë– ë‚˜ë„ ì‹œê°„ì€ Date.nowë¡œ ê³„ì‚°ë˜ë‹ˆê¹Œ, ë³µê·€í•˜ë©´ ì •í™•íˆ ë§ìŒ.
  document.addEventListener("visibilitychange", () => {
    // ìˆ¨ê²¨ì§ˆ ë•Œ ìƒíƒœ ì €ì¥
    saveTimerState();
    // ëŒì•„ì˜¬ ë•Œë„ ì—…ë°ì´íŠ¸
    if(!document.hidden){
      // í˜¹ì‹œ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ëë‚¬ë‹¤ë©´ ìƒíƒœ ë°˜ì˜
      if(running && getRemainingSec()<=0){
        running=false;
        elapsedBeforeSec = totalSec;
        startTs=null;
        stateEl.textContent="ì™„ë£Œ";
        saveTimerState();
      }
      drawTime();
      setButtons();
    }
  });

  // ====== ì´ˆê¸° ë¡œë“œ ======
  // ì €ì¥ëœ íƒ€ì´ë¨¸ ìƒíƒœ ë³µì›
  const restored = loadTimerState();
  if(restored){
    // ì…ë ¥ì¹¸ì— totalSec ë°˜ì˜
    minEl.value = Math.floor(totalSec/60);
    secEl.value = totalSec%60;
    if(running) stateEl.textContent="ì§„í–‰ ì¤‘";
    else if(getRemainingSec()<=0 && (elapsedBeforeSec>=totalSec)) stateEl.textContent="ì™„ë£Œ";
    else if(startTs===null && elapsedBeforeSec>0) stateEl.textContent="ì¼ì‹œì •ì§€";
  } else {
    // ì´ˆê¸° ê¸°ë³¸
    syncFromInputs();
    saveTimerState();
  }

  drawTime();
  setButtons();
  renderRank();
  startUiTick();
})();
</script>
</body>
</html>
