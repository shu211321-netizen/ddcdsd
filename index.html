<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ë¬¸ì œí’€ì´ íƒ€ì´ë¨¸</title>
<style>
body{margin:0;font-family:system-ui;background:#fff}
#app{min-height:100vh;display:flex;flex-direction:column;justify-content:flex-end;padding:14px;box-sizing:border-box}
.card{border:1px solid #e6e6e6;border-radius:18px;padding:14px;margin-top:12px}
.time{font-size:18vw;font-weight:900;text-align:center;letter-spacing:-.04em;line-height:1}
.sub{text-align:center;color:#666;margin-top:6px}
.row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
input,button{flex:1;padding:14px;font-size:18px;border-radius:14px;border:1px solid #ccc;box-sizing:border-box}
button{background:#111;color:#fff;font-weight:900;border:none}
.sec{background:#eee;color:#111}
.muted{color:#666;font-size:13px;margin-top:8px}

.panel{border:1px solid #eee;border-radius:18px;overflow:hidden;margin-top:12px}
.panel-h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fafafa}
.panel-h b{font-size:14px}
.panel-h button{flex:0;padding:8px 10px;border-radius:12px;font-size:14px}
.panel-b{padding:10px 12px;display:none}
.show .panel-b{display:block}

.rankTabs{display:flex;gap:8px;margin:8px 0}
.tab{flex:1;padding:10px;border-radius:12px;border:1px solid #ddd;background:#fff;color:#111;font-weight:900;font-size:14px}
.tab.on{background:#111;color:#fff;border-color:#111}
.rank{display:flex;flex-direction:column;gap:8px;max-height:28vh;overflow:auto}
.rankItem{display:flex;justify-content:space-between;gap:10px;border:1px solid #eee;border-radius:14px;padding:10px 12px}
.badge{font-weight:900;min-width:44px;text-align:center}

dialog{border:none;border-radius:18px;padding:16px;width:90vw;max-width:420px}
dialog::backdrop{background:rgba(0,0,0,.4)}
.err{color:#b00020;font-size:13px;margin-top:8px;display:none}

.pills{display:flex;gap:10px;margin-top:10px}
.pill{flex:1;padding:12px;border-radius:14px;border:1px solid #ccc;background:#fff;color:#111;font-weight:900}
.pill.on{background:#111;color:#fff;border-color:#111}
</style>
</head>

<body>
<div id="app">
  <!-- íƒ€ì´ë¨¸ -->
  <div class="card">
    <div class="time" id="time">25:00</div>
    <div class="sub" id="state">ì¤€ë¹„ë¨</div>
  </div>

  <!-- ì»¨íŠ¸ë¡¤ -->
  <div class="card">
    <div class="row">
      <input id="min" type="number" value="25" min="0" placeholder="ë¶„">
      <input id="sec" type="number" value="0" min="0" max="59" placeholder="ì´ˆ">
    </div>
    <div class="row">
      <button id="start">ì‹œì‘</button>
      <button id="pause" class="sec" disabled>ì¼ì‹œì •ì§€</button>
      <button id="resume" class="sec" disabled>ì¬ì‹œì‘</button>
      <button id="reset" class="sec">ë¦¬ì…‹</button>
    </div>
    <div class="row">
      <button id="noise" class="sec">ğŸ”¥ ì†Œë¦¬ ì¼œê¸°</button>
    </div>
    <div class="muted">
      â€» ì†Œë¦¬ëŠ” â€œì†Œë¦¬ ì¼œê¸°â€ ë²„íŠ¼ì„ ëˆ„ë¥¼ ë•Œë§Œ ì‹œì‘ë¼(ë¸Œë¼ìš°ì € ì •ì±…). íŒŒì¼ ì—†ì´ ìƒì„±ì´ë¼ ì°¨ë‹¨ ê±°ì˜ ì—†ìŒ.
    </div>
  </div>

  <!-- ë­í‚¹ -->
  <div class="panel" id="rankPanel">
    <div class="panel-h">
      <b>ğŸ† ë­í‚¹(ì •ë‹µë¥  ê¸°ì¤€)</b>
      <div style="display:flex;gap:8px">
        <button id="rankToggle" class="sec">í¼ì¹˜ê¸°</button>
        <button id="clear" class="sec">ì‚­ì œ</button>
      </div>
    </div>
    <div class="panel-b">
      <div class="rankTabs">
        <button id="tabAll" class="tab on" type="button">ì „ì²´</button>
        <button id="tabMath" class="tab" type="button">ìˆ˜í•™</button>
        <button id="tabSci" class="tab" type="button">ê³¼í•™</button>
      </div>
      <div id="rank" class="rank"></div>
      <div class="muted">ì •ë ¬: ì •ë‹µë¥ â†“ â†’ í‘¼ ê°œìˆ˜â†“ â†’ ìµœì‹ </div>
    </div>
  </div>
</div>

<!-- ê²°ê³¼ ì…ë ¥ -->
<dialog id="dlg">
  <b>ë! ê³¼ëª© + ì •ë‹µ/í’€ì´ ì…ë ¥</b>

  <div class="muted" style="margin-top:6px">ê³¼ëª©(2ê°œ)</div>
  <div class="pills">
    <button id="math" class="pill on" type="button">ìˆ˜í•™</button>
    <button id="sci" class="pill" type="button">ê³¼í•™</button>
  </div>

  <div class="muted" style="margin-top:10px">í˜•ì‹: (ë§ì€ê°œìˆ˜)/(í‘¼ê°œìˆ˜) ì˜ˆ) 18/25</div>
  <input id="score" placeholder="ì˜ˆ: 18/25" style="width:100%;margin-top:8px">

  <div class="err" id="err">ì…ë ¥ì„ í™•ì¸í•´ì¤˜.</div>

  <div class="row" style="margin-top:10px">
    <button id="skip" class="sec" type="button">ê±´ë„ˆë›°ê¸°</button>
    <button id="save" type="button">ì €ì¥</button>
  </div>
</dialog>

<script>
(() => {
  const KEY = "rankData_webAudio_v1";
  const $ = (id) => document.getElementById(id);

  const timeEl = $("time"), stateEl = $("state");
  const minEl = $("min"), secEl = $("sec");
  const startBtn = $("start"), pauseBtn = $("pause"), resumeBtn = $("resume"), resetBtn = $("reset");
  const noiseBtn = $("noise");

  const rankPanel = $("rankPanel"), rankToggle = $("rankToggle"), clearBtn = $("clear");
  const tabAll = $("tabAll"), tabMath = $("tabMath"), tabSci = $("tabSci");
  const rankEl = $("rank");

  const dlg = $("dlg"), scoreEl = $("score"), errEl = $("err");
  const mathBtn = $("math"), sciBtn = $("sci");
  const saveBtn = $("save"), skipBtn = $("skip");

  // ---------- ìƒíƒœ ----------
  let subject = "ìˆ˜í•™";
  let timer = null;
  let remaining = 25 * 60;
  let running = false;

  let filter = "ì „ì²´";
  let data = JSON.parse(localStorage.getItem(KEY) || "[]");

  // ---------- ìœ í‹¸ ----------
  const pad = (n) => String(n).padStart(2, "0");
  const fmt = (s) => `${pad(Math.floor(s / 60))}:${pad(s % 60)}`;
  const medal = (i) => i===1?"ğŸ¥‡":i===2?"ğŸ¥ˆ":i===3?"ğŸ¥‰":`#${i}`;

  function drawTime(){ timeEl.textContent = fmt(Math.max(0, remaining)); }
  function setButtons(){
    startBtn.disabled = running;
    pauseBtn.disabled = !running;
    resumeBtn.disabled = running || remaining<=0;
    minEl.disabled = running;
    secEl.disabled = running;
  }
  function syncFromInputs(){
    const mm = Math.max(0, Math.min(300, parseInt(minEl.value || 0, 10) || 0));
    const ss = Math.max(0, Math.min(59, parseInt(secEl.value || 0, 10) || 0));
    minEl.value = mm; secEl.value = ss;
    remaining = Math.max(1, mm * 60 + ss);
    drawTime();
  }

  // ---------- WebAudio (ì™¸ë¶€íŒŒì¼ X) ----------
  let noiseOn = false;
  let audioCtx = null, master = null, noiseProc = null, noiseLP = null;
  let crackGain = null, crackTimer = null;

  function soundInit(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    master = audioCtx.createGain();
    master.gain.value = 0.55; // ì „ì²´ ë³¼ë¥¨
    master.connect(audioCtx.destination);

    // ë…¸ì´ì¦ˆ: ScriptProcessor + lowpass (ë¶€ë“œëŸ¬ìš´ ë°±ìƒ‰/í•‘í¬ ëŠë‚Œ)
    const bufferSize = 4096;
    noiseProc = audioCtx.createScriptProcessor(bufferSize, 1, 1);
    noiseLP = audioCtx.createBiquadFilter();
    noiseLP.type = "lowpass";
    noiseLP.frequency.value = 1200;

    noiseProc.onaudioprocess = (e) => {
      const out = e.outputBuffer.getChannelData(0);
      for (let i=0;i<out.length;i++){
        out[i] = (Math.random()*2 - 1) * 0.22;
      }
    };

    noiseProc.connect(noiseLP);
    noiseLP.connect(master);

    // í¬ë™(ì¥ì‘ íŒ)ìš© Gain
    crackGain = audioCtx.createGain();
    crackGain.gain.value = 0.35;
    crackGain.connect(master);
  }

  function crackPop(){
    if (!audioCtx) return;
    const t = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();

    osc.type = "triangle";
    osc.frequency.setValueAtTime(120 + Math.random()*240, t);

    g.gain.setValueAtTime(0.0001, t);
    g.gain.linearRampToValueAtTime(0.22 + Math.random()*0.12, t + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.09 + Math.random()*0.08);

    osc.connect(g).connect(crackGain);
    osc.start(t);
    osc.stop(t + 0.14);
  }

  async function soundStart(){
    soundInit();
    try{
      await audioCtx.resume(); // âœ… ë²„íŠ¼ í´ë¦­ ì•ˆì—ì„œ í˜¸ì¶œë˜ë©´ ê±°ì˜ ë¬´ì¡°ê±´ ë¨
      noiseOn = true;
      noiseBtn.textContent = "ğŸ”• ì†Œë¦¬ ë„ê¸°";

      // íŒ ëœë¤
      if (crackTimer) clearInterval(crackTimer);
      crackTimer = setInterval(() => {
        if (Math.random() < 0.65) crackPop();
        if (Math.random() < 0.18) crackPop();
      }, 180);

    } catch(e){
      // ì •ë§ ë“œë¬¼ê²Œ ì‹¤íŒ¨í•˜ë©´ ì—¬ê¸°
      alert("ì†Œë¦¬ ê¶Œí•œì´ ë§‰í˜”ì–´. í¬ë¡¬ ì‚¬ì´íŠ¸ ì„¤ì •ì—ì„œ 'ì†Œë¦¬ í—ˆìš©' í›„ ë‹¤ì‹œ ëˆŒëŸ¬ì¤˜.");
      noiseOn = false;
      noiseBtn.textContent = "ğŸ”¥ ì†Œë¦¬ ì¼œê¸°";
    }
  }

  function soundStop(){
    noiseOn = false;
    noiseBtn.textContent = "ğŸ”¥ ì†Œë¦¬ ì¼œê¸°";
    if (crackTimer){ clearInterval(crackTimer); crackTimer = null; }
    if (audioCtx){ audioCtx.suspend(); }
  }

  noiseBtn.onclick = () => { if(!noiseOn) soundStart(); else soundStop(); };

  // ---------- ë­í‚¹ ----------
  function setFilter(f){
    filter = f;
    tabAll.classList.toggle("on", f==="ì „ì²´");
    tabMath.classList.toggle("on", f==="ìˆ˜í•™");
    tabSci.classList.toggle("on", f==="ê³¼í•™");
    renderRank();
  }
  tabAll.onclick = () => setFilter("ì „ì²´");
  tabMath.onclick = () => setFilter("ìˆ˜í•™");
  tabSci.onclick  = () => setFilter("ê³¼í•™");

  function renderRank(){
    rankEl.innerHTML = "";
    let arr = data.slice();
    if (filter !== "ì „ì²´") arr = arr.filter(e => e.subject === filter);

    arr.sort((a,b)=>(b.acc-a.acc)||(b.solved-a.solved)||(b.ts-a.ts));
    const top = arr.slice(0,10);
    if(!top.length){
      rankEl.innerHTML = `<div class="muted">ê¸°ë¡ ì—†ìŒ. ì €ì¥í•´ë´!</div>`;
      return;
    }
    top.forEach((e,i)=>{
      const div = document.createElement("div");
      div.className = "rankItem";
      const d = new Date(e.ts);
      const stamp = `${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      div.innerHTML = `
        <div class="badge">${medal(i+1)}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:900">${e.subject} Â· ${e.correct}/${e.solved}</div>
          <div class="muted">${stamp}</div>
        </div>
        <div style="font-weight:900">${e.acc}%</div>
      `;
      rankEl.appendChild(div);
    });
  }

  rankToggle.onclick = () => {
    const on = !rankPanel.classList.contains("show");
    rankPanel.classList.toggle("show", on);
    rankToggle.textContent = on ? "ì ‘ê¸°" : "í¼ì¹˜ê¸°";
  };

  clearBtn.onclick = () => {
    if(!confirm("ê¸°ë¡ ì „ë¶€ ì‚­ì œí• ê¹Œ?")) return;
    data = [];
    localStorage.setItem(KEY, "[]");
    renderRank();
  };

  // ---------- ê³¼ëª© ----------
  function pickSub(s){
    subject = s;
    mathBtn.classList.toggle("on", s==="ìˆ˜í•™");
    sciBtn.classList.toggle("on", s==="ê³¼í•™");
  }
  mathBtn.onclick = () => pickSub("ìˆ˜í•™");
  sciBtn.onclick  = () => pickSub("ê³¼í•™");

  // ---------- íƒ€ì´ë¨¸ ----------
  function startTick(){
    if (timer) clearInterval(timer);
    running = true;
    stateEl.textContent = "ì§„í–‰ ì¤‘";
    setButtons();
    // ì†Œë¦¬ê°€ ì¼œì ¸ ìˆìœ¼ë©´ ìœ ì§€(ì´ë¯¸ resume ìƒíƒœë¼ ë³„ë„ play í•„ìš” ì—†ìŒ)
    timer = setInterval(() => {
      remaining--;
      drawTime();
      if(remaining<=0){
        clearInterval(timer); timer=null;
        running=false;
        stateEl.textContent="ì™„ë£Œ";
        setButtons();
        soundStop(); // ì™„ë£Œ ì‹œ ì†Œë¦¬ ë” (ì›í•˜ë©´ ìœ ì§€ë¡œ ë°”ê¿”ì¤„ ìˆ˜ ìˆìŒ)
        errEl.style.display="none";
        scoreEl.value="";
        dlg.showModal();
      }
    }, 1000);
  }

  startBtn.onclick = () => {
    if (running) return;
    syncFromInputs();
    startTick();
  };

  pauseBtn.onclick = () => {
    if (!running) return;
    running=false;
    stateEl.textContent="ì¼ì‹œì •ì§€";
    setButtons();
    if (timer){ clearInterval(timer); timer=null; }
    soundStop(); // ì¼ì‹œì •ì§€ ì‹œ ì†Œë¦¬ë„ ë©ˆì¶¤ (ì›í•˜ë©´ ìœ ì§€ë¡œ ë°”ê¿ˆ)
  };

  resumeBtn.onclick = () => {
    if (running || remaining<=0) return;
    startTick();
  };

  resetBtn.onclick = () => {
    if (timer){ clearInterval(timer); timer=null; }
    running=false;
    stateEl.textContent="ì¤€ë¹„ë¨";
    syncFromInputs();
    soundStop();
    setButtons();
  };

  // ---------- ì €ì¥ ----------
  saveBtn.onclick = () => {
    const v = (scoreEl.value||"").trim();
    const m = v.match(/^(\d+)\s*\/\s*(\d+)$/);
    if(!m){
      errEl.textContent = "í˜•ì‹ì´ ì˜ëª»ëì–´. ì˜ˆ: 18/25";
      errEl.style.display="block";
      return;
    }
    const correct = parseInt(m[1],10);
    const solved  = parseInt(m[2],10);
    if(!(solved>0 && correct>=0 && correct<=solved)){
      errEl.textContent = "ìˆ«ìê°€ ì´ìƒí•´. (0 â‰¤ ë§ì€ê°œìˆ˜ â‰¤ í‘¼ê°œìˆ˜)";
      errEl.style.display="block";
      return;
    }
    errEl.style.display="none";
    const acc = Math.round(correct/solved*100);
    data.push({ ts: Date.now(), subject, correct, solved, acc });
    localStorage.setItem(KEY, JSON.stringify(data));
    dlg.close();
    renderRank();
  };

  skipBtn.onclick = () => dlg.close();

  // ---------- ì´ˆê¸° ----------
  drawTime();
  setButtons();
  renderRank();
})();
</script>
</body>
</html>
