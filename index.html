<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ë¬¸ì œí’€ì´ íƒ€ì´ë¨¸</title>
<style>
body{margin:0;font-family:system-ui;background:#fff}
#app{min-height:100vh;display:flex;flex-direction:column;justify-content:flex-end;padding:14px;box-sizing:border-box}
.card{border:1px solid #e6e6e6;border-radius:18px;padding:14px;margin-top:12px}
.time{font-size:18vw;font-weight:900;text-align:center;letter-spacing:-.04em;line-height:1}
.sub{text-align:center;color:#666;margin-top:6px}
.row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
input,button{flex:1;padding:14px;font-size:18px;border-radius:14px;border:1px solid #ccc;box-sizing:border-box}
button{background:#111;color:#fff;font-weight:900;border:none}
.sec{background:#eee;color:#111}
.muted{color:#666;font-size:13px;margin-top:8px}

.panel{border:1px solid #eee;border-radius:18px;overflow:hidden;margin-top:12px}
.panel-h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fafafa}
.panel-h b{font-size:14px}
.panel-h button{flex:0;padding:8px 10px;border-radius:12px;font-size:14px}
.panel-b{padding:10px 12px;display:none}
.show .panel-b{display:block}

.rankTabs{display:flex;gap:8px;margin:8px 0}
.tab{flex:1;padding:10px;border-radius:12px;border:1px solid #ddd;background:#fff;color:#111;font-weight:900;font-size:14px}
.tab.on{background:#111;color:#fff;border-color:#111}
.rank{display:flex;flex-direction:column;gap:8px;max-height:28vh;overflow:auto}
.rankItem{display:flex;justify-content:space-between;gap:10px;border:1px solid #eee;border-radius:14px;padding:10px 12px}
.badge{font-weight:900;min-width:44px;text-align:center}

dialog{border:none;border-radius:18px;padding:16px;width:90vw;max-width:420px}
dialog::backdrop{background:rgba(0,0,0,.4)}
.err{color:#b00020;font-size:13px;margin-top:8px;display:none}

.pills{display:flex;gap:10px;margin-top:10px}
.pill{flex:1;padding:12px;border-radius:14px;border:1px solid #ccc;background:#fff;color:#111;font-weight:900}
.pill.on{background:#111;color:#fff;border-color:#111}
</style>
</head>

<body>
<div id="app">
  <!-- íƒ€ì´ë¨¸ -->
  <div class="card">
    <div class="time" id="time">25:00</div>
    <div class="sub" id="state">ì¤€ë¹„ë¨</div>
  </div>

  <!-- ì»¨íŠ¸ë¡¤ -->
  <div class="card">
    <div class="row">
      <input id="min" type="number" value="25" min="0" placeholder="ë¶„">
      <input id="sec" type="number" value="0" min="0" max="59" placeholder="ì´ˆ">
    </div>
    <div class="row">
      <button id="start">ì‹œì‘</button>
      <button id="pause" class="sec" disabled>ì¼ì‹œì •ì§€</button>
      <button id="resume" class="sec" disabled>ì¬ì‹œì‘</button>
      <button id="finish" class="sec" disabled>ì¢…ë£Œ</button>
      <button id="reset" class="sec">ë¦¬ì…‹</button>
    </div>
    <div class="row">
      <button id="manual" class="sec">+ ê¸°ë¡ ì¶”ê°€(ìˆ˜ë™)</button>
    </div>
    <div class="muted">â€» â€œê¸°ë¡ ì¶”ê°€(ìˆ˜ë™)â€ì€ íƒ€ì´ë¨¸ë‘ ìƒê´€ì—†ì´ ë°”ë¡œ ê¸°ë¡ì„ ë„£ì„ ìˆ˜ ìˆìŒ.</div>
  </div>

  <!-- ë­í‚¹ -->
  <div class="panel" id="rankPanel">
    <div class="panel-h">
      <b>ğŸ† ë­í‚¹(ì •ë‹µë¥  ê¸°ì¤€)</b>
      <div style="display:flex;gap:8px">
        <button id="rankToggle" class="sec">í¼ì¹˜ê¸°</button>
        <button id="clear" class="sec">ì‚­ì œ</button>
      </div>
    </div>
    <div class="panel-b">
      <div class="rankTabs">
        <button id="tabAll" class="tab on" type="button">ì „ì²´</button>
        <button id="tabMath" class="tab" type="button">ìˆ˜í•™</button>
        <button id="tabSci" class="tab" type="button">ê³¼í•™</button>
      </div>
      <div id="rank" class="rank"></div>
      <div class="muted">ì •ë ¬: ì •ë‹µë¥ â†“ â†’ í‘¼ ê°œìˆ˜â†“ â†’ ìµœì‹ </div>
    </div>
  </div>
</div>

<!-- ê¸°ë¡ ì…ë ¥(ìë™/ìˆ˜ë™ ê³µìš©) -->
<dialog id="dlg">
  <b id="dlgTitle">ê¸°ë¡ ì…ë ¥</b>

  <div class="muted" id="spentInfo" style="margin-top:6px"></div>

  <div class="muted" style="margin-top:10px">ê³¼ëª©(2ê°œ)</div>
  <div class="pills">
    <button id="math" class="pill on" type="button">ìˆ˜í•™</button>
    <button id="sci" class="pill" type="button">ê³¼í•™</button>
  </div>

  <div class="muted" style="margin-top:10px">ì •ë‹µ í˜•ì‹: (ë§ì€ê°œìˆ˜)/(í‘¼ê°œìˆ˜) ì˜ˆ) 18/25</div>
  <input id="score" placeholder="ì˜ˆ: 18/25" style="width:100%;margin-top:8px">

  <div class="muted" style="margin-top:10px">ê³µë¶€ì‹œê°„(ë¶„) â€” ìˆ˜ë™ ì¶”ê°€ì¼ ë•Œë§Œ ì§ì ‘ ì…ë ¥</div>
  <input id="manualMin" type="number" min="0" placeholder="ì˜ˆ: 25" style="width:100%;margin-top:8px">

  <div class="err" id="err">ì…ë ¥ì„ í™•ì¸í•´ì¤˜.</div>

  <div class="row" style="margin-top:10px">
    <button id="skip" class="sec" type="button">ì·¨ì†Œ</button>
    <button id="save" type="button">ì €ì¥</button>
  </div>
</dialog>

<script>
(() => {
  const KEY = "rankData_manual_v1";
  const $ = (id) => document.getElementById(id);

  const timeEl = $("time"), stateEl = $("state");
  const minEl = $("min"), secEl = $("sec");
  const startBtn = $("start"), pauseBtn = $("pause"), resumeBtn = $("resume"), resetBtn = $("reset"), finishBtn = $("finish");
  const manualBtn = $("manual");

  const rankPanel = $("rankPanel"), rankToggle = $("rankToggle"), clearBtn = $("clear");
  const tabAll = $("tabAll"), tabMath = $("tabMath"), tabSci = $("tabSci");
  const rankEl = $("rank");

  const dlg = $("dlg"), dlgTitle = $("dlgTitle");
  const scoreEl = $("score"), errEl = $("err"), spentInfo = $("spentInfo"), manualMinEl = $("manualMin");
  const mathBtn = $("math"), sciBtn = $("sci");
  const saveBtn = $("save"), skipBtn = $("skip");

  let subject = "ìˆ˜í•™";
  let filter = "ì „ì²´";
  let data = JSON.parse(localStorage.getItem(KEY) || "[]");

  // íƒ€ì´ë¨¸ ìƒíƒœ
  let timer = null, running = false;
  let total = 25*60, remaining = total, startedAt = null, spent = 0;

  // ë‹¤ì´ì–¼ë¡œê·¸ ëª¨ë“œ
  let dlgMode = "auto"; // "auto"(íƒ€ì´ë¨¸ ì¢…ë£Œ/ì¢…ë£Œë²„íŠ¼), "manual"(ìˆ˜ë™ì¶”ê°€)

  const pad = (n) => String(n).padStart(2, "0");
  const fmt = (s) => `${pad(Math.floor(s / 60))}:${pad(s % 60)}`;
  const medal = (i) => i===1?"ğŸ¥‡":i===2?"ğŸ¥ˆ":i===3?"ğŸ¥‰":`#${i}`;

  function drawTime(){ timeEl.textContent = fmt(Math.max(0, remaining)); }
  function setButtons(){
    startBtn.disabled = running;
    pauseBtn.disabled = !running;
    resumeBtn.disabled = running || remaining<=0 || startedAt===null;
    finishBtn.disabled = (startedAt===null);
    minEl.disabled = running;
    secEl.disabled = running;
  }

  function syncFromInputs(){
    const mm = Math.max(0, Math.min(300, parseInt(minEl.value || 0, 10) || 0));
    const ss = Math.max(0, Math.min(59, parseInt(secEl.value || 0, 10) || 0));
    minEl.value = mm; secEl.value = ss;
    total = Math.max(1, mm*60 + ss);
    remaining = total;
    drawTime();
  }

  function pickSub(s){
    subject = s;
    mathBtn.classList.toggle("on", s==="ìˆ˜í•™");
    sciBtn.classList.toggle("on", s==="ê³¼í•™");
  }
  mathBtn.onclick = () => pickSub("ìˆ˜í•™");
  sciBtn.onclick  = () => pickSub("ê³¼í•™");

  function openDlg(mode, reason){
    dlgMode = mode;
    errEl.style.display="none";
    scoreEl.value="";
    manualMinEl.value="";
    if(mode==="manual"){
      dlgTitle.textContent="ê¸°ë¡ ì¶”ê°€(ìˆ˜ë™)";
      spentInfo.textContent="ìˆ˜ë™ ê¸°ë¡: ê³µë¶€ì‹œê°„(ë¶„)ì„ ì§ì ‘ ì ì–´ì¤˜.";
      manualMinEl.style.display="block";
    }else{
      dlgTitle.textContent="ê¸°ë¡ ì…ë ¥";
      const spentSec = Math.max(0, Math.round(spent));
      spentInfo.textContent = `ê¸°ë¡ ì‹œê°„: ${fmt(spentSec)} (ì‚¬ìœ : ${reason})`;
      manualMinEl.style.display="block"; // í‘œì‹œí•˜ë˜ ìë™ëª¨ë“œì—ì„  ë¹„ì›Œë„ ë¨
      manualMinEl.placeholder = "ìë™ì´ë©´ ë¹„ì›Œë„ ë¨";
    }
    dlg.showModal();
  }

  function startTick(){
    if (timer) clearInterval(timer);
    running = true;
    stateEl.textContent = "ì§„í–‰ ì¤‘";
    startedAt = startedAt ?? Date.now();
    let last = Date.now();

    timer = setInterval(() => {
      const now = Date.now();
      const dt = (now - last) / 1000;
      last = now;

      spent += dt;
      remaining = Math.max(0, Math.round(total - spent));
      drawTime();

      if (remaining <= 0) {
        clearInterval(timer); timer=null;
        running=false;
        stateEl.textContent = "ì™„ë£Œ";
        setButtons();
        openDlg("auto", "ì‹œê°„ ì¢…ë£Œ");
      }
    }, 250);

    setButtons();
  }

  function pauseTimer(){
    if (!running) return;
    running = false;
    stateEl.textContent = "ì¼ì‹œì •ì§€";
    if (timer) { clearInterval(timer); timer=null; }
    setButtons();
  }

  function finishTimer(){
    if (timer) { clearInterval(timer); timer=null; }
    running=false;
    stateEl.textContent="ì¢…ë£Œë¨";
    setButtons();
    openDlg("auto", "ìˆ˜ë™ ì¢…ë£Œ");
  }

  function resetTimer(){
    if (timer) { clearInterval(timer); timer=null; }
    running=false;
    stateEl.textContent="ì¤€ë¹„ë¨";
    startedAt=null;
    spent=0;
    syncFromInputs();
    setButtons();
  }

  function setFilter(f){
    filter = f;
    tabAll.classList.toggle("on", f==="ì „ì²´");
    tabMath.classList.toggle("on", f==="ìˆ˜í•™");
    tabSci.classList.toggle("on", f==="ê³¼í•™");
    renderRank();
  }
  tabAll.onclick=()=>setFilter("ì „ì²´");
  tabMath.onclick=()=>setFilter("ìˆ˜í•™");
  tabSci.onclick=()=>setFilter("ê³¼í•™");

  function renderRank(){
    rankEl.innerHTML="";
    let arr = data.slice();
    if(filter!=="ì „ì²´") arr = arr.filter(e=>e.subject===filter);

    arr.sort((a,b)=>(b.acc-a.acc)||(b.solved-a.solved)||(b.ts-a.ts));
    const top = arr.slice(0,10);

    if(!top.length){
      rankEl.innerHTML = `<div class="muted">ê¸°ë¡ ì—†ìŒ. ì €ì¥í•´ë´!</div>`;
      return;
    }

    top.forEach((e,i)=>{
      const div=document.createElement("div");
      div.className="rankItem";
      const d=new Date(e.ts);
      const stamp=`${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      div.innerHTML = `
        <div class="badge">${medal(i+1)}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:900">${e.subject} Â· ${e.correct}/${e.solved} Â· ${e.acc}%</div>
          <div class="muted">${stamp} Â· ê³µë¶€ ${fmt(e.spentSec||0)}</div>
        </div>
        <div style="font-weight:900">${e.acc}%</div>
      `;
      rankEl.appendChild(div);
    });
  }

  rankToggle.onclick=()=>{
    const on=!rankPanel.classList.contains("show");
    rankPanel.classList.toggle("show",on);
    rankToggle.textContent=on?"ì ‘ê¸°":"í¼ì¹˜ê¸°";
  };

  clearBtn.onclick=()=>{
    if(!confirm("ê¸°ë¡ ì „ë¶€ ì‚­ì œí• ê¹Œ?")) return;
    data=[];
    localStorage.setItem(KEY,"[]");
    renderRank();
  };

  // ë²„íŠ¼ ì´ë²¤íŠ¸
  startBtn.onclick=()=>{
    if(running) return;
    if(startedAt===null){
      const mm = Math.max(0, Math.min(300, parseInt(minEl.value||0,10)||0));
      const ss = Math.max(0, Math.min(59, parseInt(secEl.value||0,10)||0));
      total = Math.max(1, mm*60 + ss);
      remaining = total;
      spent = 0;
    }
    startTick();
  };
  pauseBtn.onclick=pauseTimer;
  resumeBtn.onclick=startTick;
  finishBtn.onclick=finishTimer;
  resetBtn.onclick=resetTimer;

  manualBtn.onclick=()=>openDlg("manual","");

  // ì €ì¥
  saveBtn.onclick=()=>{
    const v=(scoreEl.value||"").trim();
    const m=v.match(/^(\d+)\s*\/\s*(\d+)$/);
    if(!m){ errEl.textContent="í˜•ì‹ì´ ì˜ëª»ëì–´. ì˜ˆ: 18/25"; errEl.style.display="block"; return; }
    const correct=parseInt(m[1],10), solved=parseInt(m[2],10);
    if(!(solved>0 && correct>=0 && correct<=solved)){
      errEl.textContent="ìˆ«ìê°€ ì´ìƒí•´. (0 â‰¤ ë§ì€ê°œìˆ˜ â‰¤ í‘¼ê°œìˆ˜)";
      errEl.style.display="block"; return;
    }

    let spentSec;
    if(dlgMode==="manual"){
      const mm = parseInt(manualMinEl.value||"",10);
      if(!(mm>=0)){ errEl.textContent="ìˆ˜ë™ ê¸°ë¡ì€ ê³µë¶€ì‹œê°„(ë¶„)ì„ ìˆ«ìë¡œ ì ì–´ì¤˜."; errEl.style.display="block"; return; }
      spentSec = mm*60;
    }else{
      // ìë™ ê¸°ë¡ì€ íƒ€ì´ë¨¸ ê²½ê³¼ì‹œê°„
      spentSec = Math.max(0, Math.round(spent));
      // ì‚¬ìš©ìê°€ manualMinì— ìˆ«ìë¥¼ ë„£ì—ˆìœ¼ë©´ ê·¸ê±¸ë¡œ ë®ì–´ì“°ê¸°(ì›í•˜ë©´)
      const mm = parseInt(manualMinEl.value||"",10);
      if(mm>=0) spentSec = mm*60;
    }

    const acc=Math.round(correct/solved*100);
    data.push({ts:Date.now(),subject,correct,solved,acc,spentSec});
    localStorage.setItem(KEY,JSON.stringify(data));

    dlg.close();
    renderRank();

    // ìë™ ê¸°ë¡ì´ë©´ íƒ€ì´ë¨¸ ë¦¬ì…‹
    if(dlgMode!=="manual") resetTimer();
  };

  skipBtn.onclick=()=>{ dlg.close(); if(dlgMode!=="manual") resetTimer(); };

  // ì´ˆê¸°
  syncFromInputs();
  setButtons();
  renderRank();
})();
</script>
</body>
</html>
