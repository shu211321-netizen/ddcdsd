<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ë¬¸ì œí’€ì´ íƒ€ì´ë¨¸</title>
<style>
body{margin:0;font-family:system-ui;background:#fff}
#app{min-height:100vh;display:flex;flex-direction:column;justify-content:flex-end;padding:14px;box-sizing:border-box}
.card{border:1px solid #e6e6e6;border-radius:18px;padding:14px;margin-top:12px}
.time{font-size:18vw;font-weight:900;text-align:center;letter-spacing:-.04em;line-height:1}
.sub{text-align:center;color:#666;margin-top:6px}
.row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
input,button{flex:1;padding:14px;font-size:18px;border-radius:14px;border:1px solid #ccc;box-sizing:border-box}
button{background:#111;color:#fff;font-weight:900;border:none}
.sec{background:#eee;color:#111}
.pills{display:flex;gap:10px;margin-top:10px}
.pill{flex:1;padding:12px;border-radius:14px;border:1px solid #ccc;background:#fff;color:#111;font-weight:900}
.pill.on{background:#111;color:#fff;border-color:#111}
.panel{margin-top:10px;border:1px solid #eee;border-radius:14px;overflow:hidden}
.panel-h{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#fafafa}
.panel-h b{font-size:14px}
.panel-h button{flex:0;padding:8px 10px;border-radius:12px;font-size:14px}
.panel-b{padding:10px 12px;display:none}
.show .panel-b{display:block}
.rank{display:flex;flex-direction:column;gap:8px;max-height:28vh;overflow:auto}
.rankItem{display:flex;justify-content:space-between;gap:10px;border:1px solid #eee;border-radius:14px;padding:10px 12px}
.badge{font-weight:900;min-width:44px;text-align:center}
.muted{color:#666;font-size:13px}
dialog{border:none;border-radius:18px;padding:16px;width:90vw;max-width:420px}
dialog::backdrop{background:rgba(0,0,0,.4)}
.err{color:#b00020;font-size:13px;margin-top:8px;display:none}
</style>
</head>

<body>
<div id="app">
  <!-- íƒ€ì´ë¨¸ -->
  <div class="card">
    <div class="time" id="time">25:00</div>
    <div class="sub" id="state">ì¤€ë¹„ë¨</div>
  </div>

  <!-- ì»¨íŠ¸ë¡¤ -->
  <div class="card">
    <div class="row">
      <input id="min" type="number" value="25" min="0" placeholder="ë¶„">
      <input id="sec" type="number" value="0" min="0" max="59" placeholder="ì´ˆ">
    </div>
    <div class="row">
      <button id="start">ì‹œì‘</button>
      <button id="pause" class="sec" disabled>ì¼ì‹œì •ì§€</button>
      <button id="resume" class="sec" disabled>ì¬ì‹œì‘</button>
      <button id="reset" class="sec">ë¦¬ì…‹</button>
    </div>
    <div class="row">
      <button id="noise" class="sec">ğŸ”¥ ì†Œë¦¬ ì¼œê¸°</button>
    </div>
    <div class="muted">ì†Œë¦¬ëŠ” ë³´ì•ˆ ë•Œë¬¸ì— â€œì†Œë¦¬ ì¼œê¸°â€ ë²„íŠ¼ì„ í•œ ë²ˆ ëˆŒëŸ¬ì•¼ ì¬ìƒë¼.</div>
  </div>

  <!-- ë­í‚¹ -->
  <div class="card panel" id="rankPanel">
    <div class="panel-h">
      <b>ğŸ† ë­í‚¹(ì •ë‹µë¥  ê¸°ì¤€)</b>
      <div style="display:flex;gap:8px">
        <button id="rankToggle" class="sec">í¼ì¹˜ê¸°</button>
        <button id="clear" class="sec">ì‚­ì œ</button>
      </div>
    </div>
    <div class="panel-b">
      <div class="row" style="margin-top:0">
        <button id="tabAll" class="sec">ì „ì²´</button>
        <button id="tabMath" class="sec">ìˆ˜í•™</button>
        <button id="tabSci" class="sec">ê³¼í•™</button>
      </div>
      <div id="rank" class="rank" style="margin-top:10px"></div>
      <div class="muted" style="margin-top:8px">ì •ë ¬: ì •ë‹µë¥ â†“ â†’ í‘¼ ê°œìˆ˜â†“ â†’ ìµœì‹ </div>
    </div>
  </div>
</div>

<!-- ê²°ê³¼ ì…ë ¥ -->
<dialog id="dlg">
  <b>ë! ê³¼ëª© + ì •ë‹µ/í’€ì´ ì…ë ¥</b>

  <div class="muted" style="margin-top:6px">ê³¼ëª©(2ê°œ)</div>
  <div class="pills">
    <button id="math" class="pill on" type="button">ìˆ˜í•™</button>
    <button id="sci" class="pill" type="button">ê³¼í•™</button>
  </div>

  <div class="muted" style="margin-top:10px">í˜•ì‹: (ë§ì€ê°œìˆ˜)/(í‘¼ê°œìˆ˜) ì˜ˆ) 18/25</div>
  <input id="score" placeholder="ì˜ˆ: 18/25" style="width:100%;margin-top:8px">

  <div class="err" id="err">í˜•ì‹ì´ ì˜ëª»ëì–´. ì˜ˆ: 18/25</div>

  <div class="row" style="margin-top:10px">
    <button id="skip" class="sec" type="button">ê±´ë„ˆë›°ê¸°</button>
    <button id="save" type="button">ì €ì¥</button>
  </div>
</dialog>

<script>
(() => {
  const KEY = "rankData_v2";
  const $ = (id) => document.getElementById(id);

  const timeEl = $("time"), stateEl = $("state");
  const minEl = $("min"), secEl = $("sec");
  const startBtn = $("start"), pauseBtn = $("pause"), resumeBtn = $("resume"), resetBtn = $("reset");
  const noiseBtn = $("noise");

  const rankPanel = $("rankPanel"), rankToggle = $("rankToggle"), clearBtn = $("clear");
  const tabAll = $("tabAll"), tabMath = $("tabMath"), tabSci = $("tabSci");
  const rankEl = $("rank");

  const dlg = $("dlg"), scoreEl = $("score"), errEl = $("err");
  const mathBtn = $("math"), sciBtn = $("sci");
  const saveBtn = $("save"), skipBtn = $("skip");

  // ìƒíƒœ
  let subject = "ìˆ˜í•™";
  let timer = null;
  let remaining = 25 * 60;
  let running = false;

  // ë­í‚¹ í•„í„°
  let filter = "ì „ì²´";

  // ì†Œë¦¬ (ì¥ì‘)
  const fire = new Audio("https://cdn.pixabay.com/audio/2022/03/15/audio_2b0b8d0c8b.mp3");
  fire.loop = true;
  fire.volume = 0.6;
  let noiseOn = false;      // ì‚¬ìš©ìê°€ ì†Œë¦¬ ì¼œê¸°ë¥¼ ëˆŒë €ëŠ”ì§€(ì–¸ë½ + ON)
  let unlocked = false;     // ìµœì´ˆ ì¬ìƒ ì„±ê³µ ì—¬ë¶€

  // ë°ì´í„°
  let data = JSON.parse(localStorage.getItem(KEY) || "[]");

  const pad = (n) => String(n).padStart(2, "0");
  const fmt = (s) => `${pad(Math.floor(s / 60))}:${pad(s % 60)}`;

  const medal = (i) => i===1?"ğŸ¥‡":i===2?"ğŸ¥ˆ":i===3?"ğŸ¥‰":`#${i}`;

  function setButtons() {
    startBtn.disabled = running;        // ë‹¬ë¦¬ëŠ” ì¤‘ì´ë©´ ì‹œì‘ ë§‰ê¸°
    pauseBtn.disabled = !running;       // ë‹¬ë¦¬ëŠ” ì¤‘ë§Œ ì¼ì‹œì •ì§€ ê°€ëŠ¥
    resumeBtn.disabled = running || remaining<=0; // ë©ˆì¶˜ ìƒíƒœ(ì¼ì‹œì •ì§€)ì—ì„œë§Œ ì¬ì‹œì‘
    minEl.disabled = running;
    secEl.disabled = running;
  }

  function drawTime() {
    timeEl.textContent = fmt(Math.max(0, remaining));
  }

  function syncFromInputs() {
    const mm = Math.max(0, Math.min(300, parseInt(minEl.value || 0, 10) || 0));
    const ss = Math.max(0, Math.min(59, parseInt(secEl.value || 0, 10) || 0));
    minEl.value = mm; secEl.value = ss;
    remaining = Math.max(1, mm * 60 + ss);
    drawTime();
  }

  async function ensureSound() {
    if (!noiseOn) return;
    // ì–¸ë½ì´ ì•ˆ ëœ ìƒíƒœë©´, íƒ€ì´ë¨¸ì—ì„œ playí•´ë„ ë§‰í ìˆ˜ ìˆìŒ -> ë²„íŠ¼ìœ¼ë¡œ ë¨¼ì € ì–¸ë½ í•„ìš”
    // ê·¸ë˜ë„ í˜¹ì‹œ ì´ë¯¸ ì–¸ë½ ëìœ¼ë©´ ê³„ì† ì¬ìƒ
    try {
      await fire.play();
      unlocked = true;
    } catch (e) {
      // ë¬´ìŒ: ì‚¬ìš©ìê°€ ì†Œë¦¬ ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ì•¼ í•¨
    }
  }

  function stopSound() {
    fire.pause();
    fire.currentTime = 0;
  }

  function startTick() {
    if (timer) clearInterval(timer);
    running = true;
    stateEl.textContent = "ì§„í–‰ ì¤‘";
    setButtons();
    if (noiseOn && unlocked) fire.play().catch(()=>{});
    timer = setInterval(() => {
      remaining--;
      drawTime();
      if (remaining <= 0) {
        clearInterval(timer);
        timer = null;
        running = false;
        stateEl.textContent = "ì™„ë£Œ";
        setButtons();
        stopSound();
        errEl.style.display = "none";
        scoreEl.value = "";
        dlg.showModal();
      }
    }, 1000);
  }

  // ê³¼ëª© ì„ íƒ(2ê°œ)
  const pickSub = (s) => {
    subject = s;
    mathBtn.classList.toggle("on", s === "ìˆ˜í•™");
    sciBtn.classList.toggle("on", s === "ê³¼í•™");
  };
  mathBtn.onclick = () => pickSub("ìˆ˜í•™");
  sciBtn.onclick = () => pickSub("ê³¼í•™");

  // ë­í‚¹ íŒ¨ë„ í† ê¸€
  rankToggle.onclick = () => {
    const on = !rankPanel.classList.contains("show");
    rankPanel.classList.toggle("show", on);
    rankToggle.textContent = on ? "ì ‘ê¸°" : "í¼ì¹˜ê¸°";
  };

  // íƒ­ í•„í„°
  const setFilter = (f) => { filter = f; renderRank(); };
  tabAll.onclick = () => setFilter("ì „ì²´");
  tabMath.onclick = () => setFilter("ìˆ˜í•™");
  tabSci.onclick = () => setFilter("ê³¼í•™");

  function renderRank() {
    rankEl.innerHTML = "";
    let arr = data.slice();
    if (filter !== "ì „ì²´") arr = arr.filter(e => e.subject === filter);

    arr.sort((a, b) => (b.acc - a.acc) || (b.solved - a.solved) || (b.ts - a.ts));
    const top = arr.slice(0, 10);

    if (!top.length) {
      rankEl.innerHTML = `<div class="muted">ê¸°ë¡ ì—†ìŒ. ì €ì¥í•´ë´!</div>`;
      return;
    }

    top.forEach((e, i) => {
      const div = document.createElement("div");
      div.className = "rankItem";
      const d = new Date(e.ts);
      const stamp = `${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      div.innerHTML = `
        <div class="badge">${medal(i+1)}</div>
        <div style="flex:1">
          <div style="font-weight:900">${e.subject} Â· ${e.correct}/${e.solved}</div>
          <div class="muted">${stamp}</div>
        </div>
        <div style="font-weight:900">${e.acc}%</div>
      `;
      rankEl.appendChild(div);
    });
  }

  // ì†Œë¦¬ ë²„íŠ¼: í´ë¦­ ì´ë²¤íŠ¸ì—ì„œ "ì–¸ë½"ê¹Œì§€ í™•ì‹¤íˆ ì²˜ë¦¬
  noiseBtn.onclick = async (e) => {
    if (!noiseOn) {
      noiseOn = true;
      try {
        await fire.play();         // âœ… ì‚¬ìš©ì ì œìŠ¤ì²˜ë¡œ ì–¸ë½
        unlocked = true;
        e.target.textContent = "ğŸ”• ì†Œë¦¬ ë„ê¸°";
      } catch (err) {
        noiseOn = false;
        unlocked = false;
        alert("ì†Œë¦¬ê°€ ì°¨ë‹¨ë¨. ë‹¤ì‹œ í•œ ë²ˆ ëˆŒëŸ¬ì¤˜.");
        e.target.textContent = "ğŸ”¥ ì†Œë¦¬ ì¼œê¸°";
      }
    } else {
      noiseOn = false;
      e.target.textContent = "ğŸ”¥ ì†Œë¦¬ ì¼œê¸°";
      stopSound();
    }
  };

  // ì‹œì‘
  startBtn.onclick = async () => {
    if (running) return;
    syncFromInputs();
    await ensureSound(); // ê°€ëŠ¥í•˜ë©´ ì†Œë¦¬ ì¤€ë¹„
    startTick();
  };

  // ì¼ì‹œì •ì§€
  pauseBtn.onclick = () => {
    if (!running) return;
    running = false;
    stateEl.textContent = "ì¼ì‹œì •ì§€";
    setButtons();
    if (timer) { clearInterval(timer); timer = null; }
    stopSound();
  };

  // ì¬ì‹œì‘(ì¼ì‹œì •ì§€ í›„ ì´ì–´ì„œ)
  resumeBtn.onclick = async () => {
    if (running || remaining <= 0) return;
    await ensureSound();
    startTick();
  };

  // ë¦¬ì…‹
  resetBtn.onclick = () => {
    if (timer) { clearInterval(timer); timer = null; }
    running = false;
    stateEl.textContent = "ì¤€ë¹„ë¨";
    syncFromInputs(); // ì…ë ¥ê°’ ê¸°ì¤€ìœ¼ë¡œ ë¦¬ì…‹
    stopSound();
    setButtons();
  };

  // ì €ì¥
  saveBtn.onclick = () => {
    const v = (scoreEl.value || "").trim();
    const m = v.match(/^(\d+)\s*\/\s*(\d+)$/);
    if (!m) { errEl.textContent="í˜•ì‹ì´ ì˜ëª»ëì–´. ì˜ˆ: 18/25"; errEl.style.display="block"; return; }
    const correct = parseInt(m[1], 10), solved = parseInt(m[2], 10);
    if (!(solved > 0 && correct >= 0 && correct <= solved)) {
      errEl.textContent="ìˆ«ìê°€ ì´ìƒí•´. (0 â‰¤ ë§ì€ê°œìˆ˜ â‰¤ í‘¼ê°œìˆ˜)";
      errEl.style.display="block"; return;
    }
    errEl.style.display = "none";
    const acc = Math.round(correct / solved * 100);
    data.push({ ts: Date.now(), subject, correct, solved, acc });
    localStorage.setItem(KEY, JSON.stringify(data));
    dlg.close();
    renderRank();
  };

  skipBtn.onclick = () => dlg.close();

  // ì „ì²´ ì‚­ì œ
  clearBtn.onclick = () => {
    if (!confirm("ê¸°ë¡ ì „ë¶€ ì‚­ì œí• ê¹Œ?")) return;
    data = [];
    localStorage.setItem(KEY, "[]");
    renderRank();
  };

  // ì´ˆê¸°
  drawTime();
  setButtons();
  renderRank();
})();
</script>
</body>
</html>
